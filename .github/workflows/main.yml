name: Jupyter Docker Clean Build

on:
  workflow_dispatch:

jobs:
  docker-jupyter:
    runs-on: ubuntu-latest
    steps:
      # 1. BERSIH-BERSIH HOST (PENTING BIAR LEGA)
      - name: ðŸ§¹ Hapus Sampah Host (Free 20GB+)
        run: |
          echo "ðŸ’¾ Space Awal:"
          df -h | grep '/mnt'
          
          # Hapus Android SDK & Dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          
          # Hapus Browser di Host (Chrome/Firefox/Edge) - Kan kita pake Docker
          sudo apt-get purge -y google-chrome-stable microsoft-edge-stable firefox
          sudo apt-get autoremove -y
          sudo apt-get clean
          
          echo "âœ¨ Space Setelah Bersih-bersih:"
          df -h | grep '/mnt'

      # 2. JALANKAN JUPYTER DI DALAM DOCKER
      # Gw pake image 'scipy-notebook' biar udah ada Pandas, Numpy, Matplotlib.
      - name: ðŸ³ Run Jupyter Docker
        run: |
          docker run -d \
            --name=my-jupyter \
            -p 8888:8888 \
            -e JUPYTER_TOKEN='gantigw' \
            -e JUPYTER_ENABLE_LAB=yes \
            -v ${{ github.workspace }}:/home/jovyan/work \
            jupyter/scipy-notebook:latest

          echo "Tunggu container warming up..."
          sleep 10
          docker ps

      # 3. CLOUDFLARE TUNNEL
      - name: ðŸš‡ Start Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          # Tembak ke localhost:8888 (Port host yang dimapping dari Docker)
          cloudflared tunnel --url http://localhost:8888 > tunnel.log 2>&1 &
          
          sleep 10
          
          echo "========================================================="
          echo "ðŸ‘‡ LINK JUPYTER (DARI DALAM DOCKER) ðŸ‘‡"
          echo "========================================================="
          grep -o 'https://.*\.trycloudflare.com' tunnel.log
          echo "========================================================="
          echo "ðŸ”‘ Token: gantigw"
          echo "========================================================="

      # 4. KEEP ALIVE
      - name: â˜• Keep Alive (6 Jam)
        run: sleep 360m
